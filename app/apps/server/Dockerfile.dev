FROM node:22-alpine

RUN corepack enable && corepack prepare pnpm@10.17.1 --activate

WORKDIR /app

# Copia manifestos para cache de dependências
COPY ../../package.json ../../pnpm-lock.yaml ../../pnpm-workspace.yaml ../../turbo.json ./

# Criar estrutura de diretórios do monorepo
RUN mkdir -p apps/server apps/client

# Copia package.json files para manter a estrutura do workspace
COPY package.json ./apps/server/package.json
COPY ../../apps/client/package.json ./apps/client/package.json

RUN pnpm install --no-frozen-lockfile --shamefully-hoist

# Generate Prisma client from the server workspace
RUN pnpm --filter server prisma generate

# Copia o restante do código do servidor
COPY . ./apps/server

# Keep working directory at root for turbo commands
EXPOSE 3000

# Hot reload usando turbo dev (será sobrescrito pelo docker-compose)
CMD ["pnpm", "turbo", "-F", "server", "dev"]