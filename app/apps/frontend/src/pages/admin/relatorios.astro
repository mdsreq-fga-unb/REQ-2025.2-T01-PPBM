---
import Header from "../../components/admin/AdminHeader.svelte";
import Sidebar from "../../components/Sidebar.astro";
import FormSelect from "../../components/ui/FormSelect.astro";
import PageToast from "../../components/ui/PageToast.astro";
---

<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Relat√≥rios - Programa Bombeiro Mirim</title>
        <style>
            :root {
                --primary-color: #4a5568;
                --secondary-color: #e2e8f0;
                --accent-color: #3182ce;
                --danger-color: #e53e3e;
                --bg-color: #f7fafc;
                --text-color: #2d3748;
                --label-color: #718096;
                --border-color: #cbd5e0;
                --white: #ffffff;
                --success-color: #48bb78;
                --warning-color: #ed8936;
                --info-color: #4299e1;
            }
            body {
                font-family: "Inter", sans-serif;
                background-color: var(--bg-color);
                color: var(--text-color);
                margin: 0;
                padding: 0;
            }
            .main-content {
                padding: 120px 1.5rem 40px;
                min-height: 100vh;
                display: flex;
                justify-content: center;
            }
            .content-wrapper {
                width: 100%;
                max-width: 1280px;
                display: flex;
                gap: 20px;
                align-items: flex-start;
            }
            .container {
                flex: 1;
                max-width: 100%;
                background-color: var(--white);
                padding: 2.5rem;
                border-radius: 1.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                padding-bottom: 1.5rem;
                border-bottom: 2px solid var(--secondary-color);
            }
            .page-header h1 {
                font-size: 1.8rem;
                margin: 0;
                color: var(--text-color);
            }
            .header-actions {
                display: flex;
                gap: 1rem;
            }
            .btn-generate,
            .btn-export {
                padding: 0.75rem 1.5rem;
                border-radius: 6px;
                border: none;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.3s;
                white-space: nowrap;
            }
            .btn-generate {
                background-color: var(--primary-color);
                color: var(--white);
            }
            .btn-generate:hover {
                background-color: #2d3748;
            }
            .btn-export {
                background-color: var(--danger-color);
                color: var(--white);
            }
            .btn-export:hover {
                background-color: #c53030;
            }
            .btn-export:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
            .filters-section {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-bottom: 2rem;
            }
            .filter-group {
                display: flex;
                flex-direction: column;
            }
            .filter-group label {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
                color: var(--label-color);
                font-weight: 500;
            }
            .filter-group select,
            .filter-group input {
                padding: 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                font-size: 1rem;
                color: var(--text-color);
                background-color: #fdfdfd;
            }
            .filter-group select:focus,
            .filter-group input:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2);
            }
            .date-input-wrapper {
                position: relative;
            }
            .date-icon {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
                color: var(--label-color);
            }
            .instruction-text {
                color: var(--label-color);
                font-size: 0.95rem;
                margin-bottom: 2rem;
                padding: 1rem;
                background-color: #f7fafc;
                border-radius: 6px;
                border-left: 3px solid var(--accent-color);
            }
            .report-container {
                margin-top: 2rem;
                display: none;
            }
            .report-container.active {
                display: block;
            }
            .report-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid var(--secondary-color);
            }
            .report-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: var(--text-color);
            }
            .report-info {
                font-size: 0.9rem;
                color: var(--label-color);
            }
            .report-content {
                margin-top: 1.5rem;
            }
            .report-table {
                width: 100%;
                border-collapse: collapse;
                background-color: var(--white);
                margin-top: 1rem;
            }
            .report-table thead {
                background-color: var(--secondary-color);
            }
            .report-table th {
                padding: 1rem;
                text-align: left;
                font-weight: 600;
                color: var(--text-color);
                font-size: 0.9rem;
                border-bottom: 2px solid var(--border-color);
            }
            .report-table td {
                padding: 1rem;
                border-bottom: 1px solid var(--border-color);
                font-size: 0.95rem;
            }
            .report-table tbody tr:hover {
                background-color: #f7fafc;
            }
            .report-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
            .stat-card {
                padding: 1.5rem;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            .stat-card h3 {
                font-size: 0.9rem;
                margin: 0 0 0.5rem 0;
                font-weight: 500;
                color: var(--label-color);
            }
            .stat-card .value {
                font-size: 2.5rem;
                font-weight: 700;
                margin: 0;
                color: var(--text-color);
            }
            .charts-section {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
            .chart-container {
                background-color: var(--white);
                padding: 1.5rem;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            .chart-container h3 {
                font-size: 1rem;
                margin: 0 0 1rem 0;
                color: var(--text-color);
                font-weight: 600;
            }
            .chart-wrapper {
                position: relative;
                width: 100%;
                max-height: 300px;
            }
            .chart-wrapper canvas {
                max-height: 300px;
            }
            .chart-container.full-width {
                grid-column: 1 / -1;
            }
            .chart-container.full-width .chart-wrapper {
                max-height: 350px;
            }
            .chart-container.full-width .chart-wrapper canvas {
                max-height: 350px;
            }

            @media (max-width: 768px) {
                .main-content {
                    padding: 100px 1rem 20px;
                }

                .content-wrapper {
                    flex-direction: column;
                    gap: 15px;
                }

                .container {
                    padding: 1.5rem;
                    border-radius: 1rem;
                }

                .page-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 1rem;
                }

                .page-header h1 {
                    font-size: 1.5rem;
                }

                .header-actions {
                    width: 100%;
                }

                .btn-generate,
                .btn-export {
                    flex: 1;
                }

                .filters-section {
                    grid-template-columns: 1fr;
                }

                .report-stats {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 1rem;
                }

                .report-table {
                    font-size: 0.85rem;
                }

                .report-table th,
                .report-table td {
                    padding: 0.75rem 0.5rem;
                }

                .charts-section {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }

                .chart-container {
                    padding: 1rem;
                }

                .chart-container h3 {
                    font-size: 0.9rem;
                }

                .chart-wrapper {
                    max-height: 250px;
                }

                .chart-wrapper canvas {
                    max-height: 250px;
                }

                .chart-container.full-width .chart-wrapper {
                    max-height: 280px;
                }

                .chart-container.full-width .chart-wrapper canvas {
                    max-height: 280px;
                }
            }

            @media (max-width: 480px) {
                .main-content {
                    padding: 80px 0.5rem 20px;
                }

                .container {
                    padding: 1rem;
                    border-radius: 0.75rem;
                }

                .page-header h1 {
                    font-size: 1.25rem;
                }

                .header-actions {
                    flex-direction: column;
                }

                .report-stats {
                    grid-template-columns: 1fr;
                }

                .stat-card .value {
                    font-size: 2rem;
                }

                .chart-wrapper {
                    max-height: 220px;
                }

                .chart-wrapper canvas {
                    max-height: 220px;
                }

                .chart-container.full-width .chart-wrapper {
                    max-height: 250px;
                }

                .chart-container.full-width .chart-wrapper canvas {
                    max-height: 250px;
                }
            }
        </style>
    </head>
    <body>
        <Header client:load />

        <main class="main-content">
            <div class="content-wrapper">
                <Sidebar />
                <div class="container">
                    <div class="page-header">
                        <h1>Relat√≥rios</h1>
                        <div class="header-actions">
                            <button
                                type="button"
                                class="btn-generate"
                                id="btn-generate">Gerar</button
                            >
                            <button
                                type="button"
                                class="btn-export"
                                id="btn-export"
                                disabled>Exportar</button
                            >
                        </div>
                    </div>

                    <div class="filters-section">
                        <FormSelect
                            id="tipo-relatorio"
                            name="tipo-relatorio"
                            label="Tipo de relat√≥rio"
                        >
                            <option value="presencas-periodo"
                                >Presen√ßas por per√≠odo</option
                            >
                            <option value="presencas-turma"
                                >Presen√ßas por turma</option
                            >
                            <option value="individual"
                                >Relat√≥rio individual</option
                            >
                            <option value="frequencia-geral"
                                >Frequ√™ncia geral</option
                            >
                        </FormSelect>
                        <div class="filter-group">
                            <label for="data-inicial">Data inicial</label>
                            <div class="date-input-wrapper">
                                <input
                                    type="date"
                                    id="data-inicial"
                                    name="data-inicial"
                                    value="2025-11-10"
                                />
                                <span class="date-icon">üìÖ</span>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="data-final">Data final</label>
                            <div class="date-input-wrapper">
                                <input
                                    type="date"
                                    id="data-final"
                                    name="data-final"
                                    value="2025-11-10"
                                />
                                <span class="date-icon">üìÖ</span>
                            </div>
                        </div>
                        <FormSelect id="turma" name="turma" label="Turma">
                            <option value="">Todas</option>
                            <!-- Turmas ser√£o carregadas via JavaScript -->
                        </FormSelect>
                        <div class="filter-group" id="aluno-filter" style="display: none;">
                            <label for="aluno">Aluno</label>
                            <select id="aluno" name="aluno">
                                <option value="">Selecione um aluno</option>
                                <!-- Alunos ser√£o carregados via JavaScript -->
                            </select>
                        </div>
                    </div>

                    <div class="instruction-text">
                        Selecione os filtros e clique em "Gerar" para visualizar
                        o relat√≥rio
                    </div>

                    <div class="report-container" id="report-container">
                        <div class="report-header">
                            <div>
                                <div class="report-title" id="report-title">
                                    Relat√≥rio de Presen√ßas por Per√≠odo
                                </div>
                                <div class="report-info" id="report-info">
                                    Per√≠odo: 10/11/2025 a 10/11/2025 | Turma:
                                    Todas
                                </div>
                            </div>
                        </div>

                        <div class="report-content" id="report-content">
                            <!-- Conte√∫do do relat√≥rio ser√° inserido aqui via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            import { apiFetch } from "../../lib/api";
            import { authStore } from "../../stores/auth";
            import { Chart, registerables } from "chart.js";

            // Register all Chart.js components
            Chart.register(...registerables);

            const btnGenerate = document.getElementById("btn-generate");
            const btnExport = document.getElementById("btn-export");
            const reportContainer = document.getElementById("report-container");
            const reportContent = document.getElementById("report-content");
            const reportTitle = document.getElementById("report-title");
            const reportInfo = document.getElementById("report-info");
            const tipoRelatorioSelect = document.getElementById("tipo-relatorio");
            const alunoFilter = document.getElementById("aluno-filter");
            const alunoSelect = document.getElementById("aluno");
            const turmaSelect = document.getElementById("turma");

            let currentReportData = null;
            let turmasCache = [];
            let alunosCache = [];
            let activeCharts = [];

            // Chart color scheme
            const chartColors = {
                presente: { bg: 'rgba(72, 187, 120, 0.8)', border: '#48BB78' },
                atraso: { bg: 'rgba(237, 137, 54, 0.8)', border: '#ED8936' },
                falta: { bg: 'rgba(229, 62, 62, 0.8)', border: '#E53E3E' },
                primary: { bg: 'rgba(49, 130, 206, 0.8)', border: '#3182CE' }
            };

            // Destroy all active charts
            function destroyCharts() {
                activeCharts.forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                activeCharts = [];
            }

            // Create donut chart for attendance distribution
            function createDistributionChart(canvasId, data) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return null;
                
                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Presen√ßas', 'Atrasos', 'Faltas'],
                        datasets: [{
                            data: [data.presentes || 0, data.atrasos || 0, data.faltas || 0],
                            backgroundColor: [chartColors.presente.bg, chartColors.atraso.bg, chartColors.falta.bg],
                            borderColor: [chartColors.presente.border, chartColors.atraso.border, chartColors.falta.border],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: { size: 12, family: 'Inter' }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                        return `${context.label}: ${context.raw} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                activeCharts.push(chart);
                return chart;
            }

            // Create bar chart for turma comparison
            function createTurmaChart(canvasId, turmas) {
                const canvas = document.getElementById(canvasId);
                if (!canvas || !turmas || turmas.length === 0) return null;
                
                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: turmas.map(t => t.nome || 'Sem nome'),
                        datasets: [
                            {
                                label: 'Presen√ßas',
                                data: turmas.map(t => t.presente || 0),
                                backgroundColor: chartColors.presente.bg,
                                borderColor: chartColors.presente.border,
                                borderWidth: 1
                            },
                            {
                                label: 'Atrasos',
                                data: turmas.map(t => t.atraso || 0),
                                backgroundColor: chartColors.atraso.bg,
                                borderColor: chartColors.atraso.border,
                                borderWidth: 1
                            },
                            {
                                label: 'Faltas',
                                data: turmas.map(t => t.falta || 0),
                                backgroundColor: chartColors.falta.bg,
                                borderColor: chartColors.falta.border,
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: { size: 12, family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11, family: 'Inter' } }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                ticks: { font: { size: 11, family: 'Inter' } }
                            }
                        }
                    }
                });
                activeCharts.push(chart);
                return chart;
            }

            // Create line chart for trends
            function createTrendChart(canvasId, tendencia) {
                const canvas = document.getElementById(canvasId);
                if (!canvas || !tendencia || tendencia.length === 0) return null;
                
                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: tendencia.map(t => {
                            const date = new Date(t.data);
                            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        }),
                        datasets: [
                            {
                                label: 'Presen√ßas',
                                data: tendencia.map(t => t.presente || 0),
                                borderColor: chartColors.presente.border,
                                backgroundColor: 'rgba(72, 187, 120, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Atrasos',
                                data: tendencia.map(t => t.atraso || 0),
                                borderColor: chartColors.atraso.border,
                                backgroundColor: 'rgba(237, 137, 54, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Faltas',
                                data: tendencia.map(t => t.falta || 0),
                                borderColor: chartColors.falta.border,
                                backgroundColor: 'rgba(229, 62, 62, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: { size: 12, family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { 
                                    font: { size: 10, family: 'Inter' },
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                ticks: { font: { size: 11, family: 'Inter' } }
                            }
                        }
                    }
                });
                activeCharts.push(chart);
                return chart;
            }

            // Create horizontal bar chart for top students
            function createTopAlunosChart(canvasId, alunos) {
                const canvas = document.getElementById(canvasId);
                if (!canvas || !alunos || alunos.length === 0) return null;
                
                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: alunos.map(a => a.nome || 'Desconhecido'),
                        datasets: [{
                            label: 'Taxa de Presen√ßa (%)',
                            data: alunos.map(a => a.taxaPresenca || 0),
                            backgroundColor: alunos.map(a => {
                                const rate = a.taxaPresenca || 0;
                                if (rate >= 75) return chartColors.presente.bg;
                                if (rate >= 50) return chartColors.atraso.bg;
                                return chartColors.falta.bg;
                            }),
                            borderColor: alunos.map(a => {
                                const rate = a.taxaPresenca || 0;
                                if (rate >= 75) return chartColors.presente.border;
                                if (rate >= 50) return chartColors.atraso.border;
                                return chartColors.falta.border;
                            }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                ticks: { 
                                    font: { size: 11, family: 'Inter' },
                                    callback: value => `${value}%`
                                }
                            },
                            y: {
                                grid: { display: false },
                                ticks: { font: { size: 11, family: 'Inter' } }
                            }
                        }
                    }
                });
                activeCharts.push(chart);
                return chart;
            }

            // Fun√ß√£o para formatar data
            function formatarData(data) {
                const date = new Date(data);
                return date.toLocaleDateString("pt-BR");
            }

            // Carregar turmas
            async function carregarTurmas() {
                try {
                    const response = await apiFetch("/turmas/listar?pageSize=100");
                    if (response.success && response.data) {
                        turmasCache = response.data.data || response.data || [];
                        turmaSelect.innerHTML = '<option value="">Todas</option>';
                        turmasCache.forEach(turma => {
                            const option = document.createElement("option");
                            option.value = turma.id_turma;
                            option.textContent = `${turma.nome_turma}${turma.unidade_turma ? ` - ${turma.unidade_turma}` : ''}`;
                            turmaSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error("Erro ao carregar turmas:", error);
                }
            }

            // Carregar alunos
            async function carregarAlunos() {
                try {
                    const response = await apiFetch("/alunos/listar?pageSize=500");
                    if (response.success && response.data) {
                        alunosCache = response.data.data || response.data || [];
                        alunoSelect.innerHTML = '<option value="">Selecione um aluno</option>';
                        alunosCache.forEach(aluno => {
                            const option = document.createElement("option");
                            option.value = aluno.id_aluno;
                            option.textContent = aluno.nome_aluno;
                            alunoSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error("Erro ao carregar alunos:", error);
                }
            }

            // Mostrar/ocultar filtro de aluno baseado no tipo
            tipoRelatorioSelect.addEventListener("change", () => {
                if (tipoRelatorioSelect.value === "individual") {
                    alunoFilter.style.display = "flex";
                } else {
                    alunoFilter.style.display = "none";
                }
            });

            // Fun√ß√£o para gerar relat√≥rio
            async function gerarRelatorio() {
                const tipoRelatorio = tipoRelatorioSelect.value;
                const dataInicial = document.getElementById("data-inicial").value;
                const dataFinal = document.getElementById("data-final").value;
                const turma = turmaSelect.value;
                const aluno = alunoSelect.value;

                // Valida√ß√£o
                if (!dataInicial || !dataFinal) {
                    if (typeof window.showPageToast === "function") {
                        window.showPageToast("Por favor, selecione as datas inicial e final", "warning");
                    }
                    return;
                }

                if (new Date(dataInicial) > new Date(dataFinal)) {
                    if (typeof window.showPageToast === "function") {
                        window.showPageToast("A data inicial n√£o pode ser maior que a data final", "warning");
                    }
                    return;
                }

                if (tipoRelatorio === "individual" && !aluno) {
                    if (typeof window.showPageToast === "function") {
                        window.showPageToast("Por favor, selecione um aluno para o relat√≥rio individual", "warning");
                    }
                    return;
                }

                // Mostrar loading
                reportContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: #718096;">Carregando...</div>';
                reportContainer.classList.add("active");

                try {
                    if (tipoRelatorio === "individual") {
                        // Relat√≥rio individual - usa o endpoint de estat√≠sticas do aluno
                        currentReportData = await gerarRelatorioIndividual(aluno, dataInicial, dataFinal);
                    } else {
                        // Outros relat√≥rios - usa o endpoint de presen√ßas
                        currentReportData = await gerarRelatorioPresencas(tipoRelatorio, dataInicial, dataFinal, turma);
                    }

                    // Atualizar t√≠tulo
                    const tipoRelatorioText = tipoRelatorioSelect.selectedOptions[0].text;
                    const turmaText = turma ? turmaSelect.selectedOptions[0].text : "Todas";
                    
                    reportTitle.textContent = `Relat√≥rio de ${tipoRelatorioText}`;
                    
                    if (tipoRelatorio === "individual" && currentReportData.aluno) {
                        reportInfo.textContent = `Aluno: ${currentReportData.aluno.nome_aluno} | Per√≠odo: ${formatarData(dataInicial)} a ${formatarData(dataFinal)}`;
                    } else {
                        reportInfo.textContent = `Per√≠odo: ${formatarData(dataInicial)} a ${formatarData(dataFinal)} | Turma: ${turmaText}`;
                    }

                    renderizarRelatorio(currentReportData, tipoRelatorio);
                    btnExport.disabled = false;
                } catch (error) {
                    console.error("Erro ao gerar relat√≥rio:", error);
                    if (typeof window.showPageToast === "function") {
                        window.showPageToast("Erro ao gerar relat√≥rio. Tente novamente.", "error");
                    }
                    reportContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: #c53030;">Erro ao carregar dados do relat√≥rio.</div>';
                }
            }

            // Gerar relat√≥rio individual
            async function gerarRelatorioIndividual(alunoId, dataInicial, dataFinal) {
                const response = await apiFetch(`/alunos/estatisticas/${alunoId}?from=${dataInicial}&to=${dataFinal}`);
                if (response.success && response.data) {
                    const serverData = response.data.data || response.data;
                    return {
                        tipo: "individual",
                        aluno: serverData.aluno,
                        estatisticas: serverData.estatisticas,
                        periodo: { inicio: dataInicial, fim: dataFinal }
                    };
                }
                throw new Error("Falha ao carregar estat√≠sticas do aluno");
            }

            // Gerar relat√≥rio de presen√ßas usando o novo endpoint de estat√≠sticas
            async function gerarRelatorioPresencas(tipo, dataInicial, dataFinal, turmaId) {
                const params = new URLSearchParams();
                params.append("from", dataInicial);
                params.append("to", dataFinal);
                if (turmaId) params.append("turmaId", turmaId);

                const response = await apiFetch(`/presencas/estatisticas?${params}`);
                if (response.success && response.data) {
                    const statsData = response.data.data || response.data;
                    
                    // Transform data for report rendering
                    const detalhes = (statsData.todosAlunos || []).map(aluno => ({
                        aluno: aluno.nome,
                        presentes: aluno.presente,
                        faltas: aluno.falta,
                        atrasos: aluno.atraso,
                        taxaPresenca: aluno.taxaPresenca
                    }));

                    return {
                        tipo,
                        periodo: { inicio: dataInicial, fim: dataFinal },
                        turmaId,
                        estatisticas: {
                            total_alunos: detalhes.length,
                            presentes: statsData.resumo?.presente || 0,
                            faltas: statsData.resumo?.falta || 0,
                            atrasos: statsData.resumo?.atraso || 0,
                            taxaPresenca: statsData.resumo?.taxaPresenca || 0
                        },
                        detalhes,
                        porTurma: statsData.porTurma || [],
                        tendencia: statsData.tendencia || [],
                        topAlunos: statsData.topAlunos || []
                    };
                }
                throw new Error("Falha ao carregar estat√≠sticas de presen√ßas");
            }

            // Fun√ß√£o para renderizar relat√≥rio
            function renderizarRelatorio(data, tipo) {
                // Destroy any existing charts first
                destroyCharts();
                
                let html = "";

                if (tipo === "individual" && data.estatisticas) {
                    const stats = data.estatisticas;
                    const taxaPresenca = stats.presenca?.taxaPresenca || 0;
                    const presentes = stats.presenca?.presentes || 0;
                    const faltas = stats.presenca?.faltas || 0;
                    const atrasos = stats.presenca?.atrasos || 0;
                    
                    // Estat√≠sticas
                    html += '<div class="report-stats">';
                    html += `<div class="stat-card" style="background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%); color: white;"><h3 style="color: rgba(255,255,255,0.9);">Taxa de Presen√ßa</h3><p class="value" style="color: white;">${taxaPresenca}%</p></div>`;
                    html += `<div class="stat-card" style="background: linear-gradient(135deg, #48BB78 0%, #2F855A 100%); color: white;"><h3 style="color: rgba(255,255,255,0.9);">Presen√ßas</h3><p class="value" style="color: white;">${presentes}</p></div>`;
                    html += `<div class="stat-card" style="background: linear-gradient(135deg, #E53E3E 0%, #C53030 100%); color: white;"><h3 style="color: rgba(255,255,255,0.9);">Faltas</h3><p class="value" style="color: white;">${faltas}</p></div>`;
                    html += `<div class="stat-card" style="background: linear-gradient(135deg, #ED8936 0%, #C05621 100%); color: white;"><h3 style="color: rgba(255,255,255,0.9);">Atrasos</h3><p class="value" style="color: white;">${atrasos}</p></div>`;
                    html += "</div>";

                    // Charts for individual report
                    html += '<div class="charts-section">';
                    html += '<div class="chart-container"><h3>Distribui√ß√£o de Frequ√™ncia</h3><div class="chart-wrapper"><canvas id="individual-distribution-chart"></canvas></div></div>';
                    html += '</div>';

                    // Resumo adicional
                    html += '<div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
                    html += `<div style="padding: 1rem; background: #f7fafc; border-radius: 8px; border-left: 3px solid #805ad5;">
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #553c9a;">üìÑ Justificativas</h4>
                        <p style="margin: 0; font-size: 0.85rem; color: #4a5568;">Total: ${stats.justificativas?.total || 0} | Aprovadas: ${stats.justificativas?.aprovadas || 0}</p>
                    </div>`;
                    html += `<div style="padding: 1rem; background: #f7fafc; border-radius: 8px; border-left: 3px solid #e53e3e;">
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #c53030;">‚ö†Ô∏è Advert√™ncias</h4>
                        <p style="margin: 0; font-size: 0.85rem; color: #4a5568;">Total: ${stats.advertencias?.total || 0}</p>
                    </div>`;
                    html += "</div>";

                    // Set content and create chart
                    reportContent.innerHTML = html;
                    
                    // Create chart after DOM is updated
                    setTimeout(() => {
                        createDistributionChart('individual-distribution-chart', { presentes, atrasos, faltas });
                    }, 50);

                } else if (data.estatisticas) {
                    const taxaPresenca = data.estatisticas.taxaPresenca || 0;
                    
                    // Estat√≠sticas gerais
                    html += '<div class="report-stats">';
                    html += `<div class="stat-card"><h3>Total de Alunos</h3><p class="value">${data.estatisticas.total_alunos}</p></div>`;
                    html += `<div class="stat-card" style="background: linear-gradient(135deg, #48BB78 0%, #2F855A 100%); color: white;"><h3 style="color: rgba(255,255,255,0.9);">Presen√ßas</h3><p class="value" style="color: white;">${data.estatisticas.presentes}</p></div>`;
                    html += `<div class="stat-card" style="background: linear-gradient(135deg, #E53E3E 0%, #C53030 100%); color: white;"><h3 style="color: rgba(255,255,255,0.9);">Faltas</h3><p class="value" style="color: white;">${data.estatisticas.faltas}</p></div>`;
                    html += `<div class="stat-card" style="background: linear-gradient(135deg, #ED8936 0%, #C05621 100%); color: white;"><h3 style="color: rgba(255,255,255,0.9);">Atrasos</h3><p class="value" style="color: white;">${data.estatisticas.atrasos}</p></div>`;
                    html += "</div>";

                    // Charts section
                    html += '<div class="charts-section">';
                    
                    // Donut chart for distribution
                    html += '<div class="chart-container"><h3>Distribui√ß√£o Geral</h3><div class="chart-wrapper"><canvas id="distribution-chart"></canvas></div></div>';
                    
                    // Bar chart for turma comparison (if available and report type is presencas-turma or frequencia-geral)
                    if ((tipo === "presencas-turma" || tipo === "frequencia-geral") && data.porTurma && data.porTurma.length > 0) {
                        html += '<div class="chart-container"><h3>Comparativo por Turma</h3><div class="chart-wrapper"><canvas id="turma-chart"></canvas></div></div>';
                    }
                    
                    // Top students chart
                    if (data.topAlunos && data.topAlunos.length > 0) {
                        html += '<div class="chart-container"><h3>Top 10 Alunos por Frequ√™ncia</h3><div class="chart-wrapper"><canvas id="top-alunos-chart"></canvas></div></div>';
                    }
                    
                    html += '</div>';
                    
                    // Trend chart (full width)
                    if (data.tendencia && data.tendencia.length > 1) {
                        html += '<div class="charts-section">';
                        html += '<div class="chart-container full-width"><h3>Tend√™ncia de Frequ√™ncia no Per√≠odo</h3><div class="chart-wrapper"><canvas id="trend-chart"></canvas></div></div>';
                        html += '</div>';
                    }

                    // Tabela de detalhes
                    if (data.detalhes && data.detalhes.length > 0) {
                        html += '<h3 style="margin: 2rem 0 1rem; font-size: 1.1rem; color: #2d3748;">Detalhamento por Aluno</h3>';
                        html += '<table class="report-table">';
                        html += "<thead><tr><th>Aluno</th><th>Presen√ßas</th><th>Faltas</th><th>Atrasos</th><th>Taxa</th></tr></thead>";
                        html += "<tbody>";
                        data.detalhes.forEach((item) => {
                            const total = item.presentes + item.faltas + item.atrasos;
                            const taxa = item.taxaPresenca !== undefined ? item.taxaPresenca : (total > 0 ? Math.round(((item.presentes + item.atrasos) / total) * 100) : 0);
                            html += `<tr>
                                <td>${item.aluno}</td>
                                <td>${item.presentes}</td>
                                <td>${item.faltas}</td>
                                <td>${item.atrasos}</td>
                                <td><span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; ${taxa >= 75 ? 'background: #c6f6d5; color: #22543d;' : taxa >= 50 ? 'background: #feebc8; color: #744210;' : 'background: #fed7d7; color: #742a2a;'}">${taxa}%</span></td>
                            </tr>`;
                        });
                        html += "</tbody></table>";
                    }
                    
                    // Set content first, then create charts
                    reportContent.innerHTML = html;
                    
                    // Create charts after DOM is updated
                    setTimeout(() => {
                        // Distribution chart
                        createDistributionChart('distribution-chart', {
                            presentes: data.estatisticas.presentes,
                            atrasos: data.estatisticas.atrasos,
                            faltas: data.estatisticas.faltas
                        });
                        
                        // Turma chart
                        if ((tipo === "presencas-turma" || tipo === "frequencia-geral") && data.porTurma && data.porTurma.length > 0) {
                            createTurmaChart('turma-chart', data.porTurma);
                        }
                        
                        // Trend chart
                        if (data.tendencia && data.tendencia.length > 1) {
                            createTrendChart('trend-chart', data.tendencia);
                        }
                        
                        // Top students chart
                        if (data.topAlunos && data.topAlunos.length > 0) {
                            createTopAlunosChart('top-alunos-chart', data.topAlunos);
                        }
                    }, 50);
                    
                    return; // Already set innerHTML above
                } else {
                    html = '<div style="text-align: center; padding: 2rem; color: #718096;">Nenhum dado dispon√≠vel para este relat√≥rio.</div>';
                }

                reportContent.innerHTML = html;
            }

            // Fun√ß√£o para exportar relat√≥rio
            function exportarRelatorio() {
                if (!currentReportData) {
                    if (typeof window.showPageToast === "function") {
                        window.showPageToast("Gere um relat√≥rio antes de exportar", "warning");
                    }
                    return;
                }

                const tipoRelatorio = tipoRelatorioSelect.value;
                const dataInicial = document.getElementById("data-inicial").value;
                const dataFinal = document.getElementById("data-final").value;

                // Criar conte√∫do CSV
                let csvContent = "";

                if (tipoRelatorio === "individual" && currentReportData.estatisticas) {
                    const stats = currentReportData.estatisticas;
                    csvContent = "M√©trica,Valor\n";
                    csvContent += `"Aluno","${currentReportData.aluno?.nome_aluno || ''}"\n`;
                    csvContent += `"Taxa de Presen√ßa","${stats.presenca?.taxaPresenca || 0}%"\n`;
                    csvContent += `"Total de Aulas",${stats.presenca?.totalAulas || 0}\n`;
                    csvContent += `"Presen√ßas",${stats.presenca?.presentes || 0}\n`;
                    csvContent += `"Faltas",${stats.presenca?.faltas || 0}\n`;
                    csvContent += `"Atrasos",${stats.presenca?.atrasos || 0}\n`;
                    csvContent += `"Justificativas",${stats.justificativas?.total || 0}\n`;
                    csvContent += `"Advert√™ncias",${stats.advertencias?.total || 0}\n`;
                } else if (currentReportData.detalhes) {
                    csvContent = "Aluno,Presen√ßas,Faltas,Atrasos,Taxa\n";
                    currentReportData.detalhes.forEach((item) => {
                        const total = item.presentes + item.faltas + item.atrasos;
                        const taxa = total > 0 ? Math.round(((item.presentes + item.atrasos) / total) * 100) : 0;
                        csvContent += `"${item.aluno}",${item.presentes},${item.faltas},${item.atrasos},${taxa}%\n`;
                    });
                }

                // Criar e baixar arquivo
                const blob = new Blob(["\ufeff" + csvContent], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `relatorio_${tipoRelatorio}_${dataInicial}_${dataFinal}.csv`);
                link.style.visibility = "hidden";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                if (typeof window.showPageToast === "function") {
                    window.showPageToast("Relat√≥rio exportado com sucesso!", "success");
                }
            }

            // Event listeners
            btnGenerate.addEventListener("click", gerarRelatorio);
            btnExport.addEventListener("click", exportarRelatorio);

            // Inicializa√ß√£o
            document.addEventListener("DOMContentLoaded", async () => {
                const isAuthenticated = await authStore.checkAuth();
                if (!isAuthenticated) {
                    window.location.href = "/login";
                    return;
                }

                // Definir data padr√£o (√∫ltimo m√™s)
                const hoje = new Date();
                const mesPassado = new Date(hoje);
                mesPassado.setMonth(mesPassado.getMonth() - 1);
                
                document.getElementById("data-inicial").value = mesPassado.toISOString().split("T")[0];
                document.getElementById("data-final").value = hoje.toISOString().split("T")[0];

                // Carregar dados
                await Promise.all([carregarTurmas(), carregarAlunos()]);
            });
        </script>
        <PageToast />
    </body>
</html>
