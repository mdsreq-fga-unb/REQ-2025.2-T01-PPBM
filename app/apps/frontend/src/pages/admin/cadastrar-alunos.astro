---
import Header from "../../components/admin/AdminHeader.svelte";
import Sidebar from "../../components/Sidebar.astro";
import FormSelect from "../../components/ui/FormSelect.astro";
import ResponsaveisSection from "../../components/ResponsaveisSection.svelte";
import PageToast from "../../components/ui/PageToast.astro";
import DocumentosAluno from "../../components/admin/DocumentosAluno.svelte";
---

<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title id="page-title">Cadastrar Aluno - Programa Bombeiro Mirim</title>
        <style>
            :root {
                --primary-color: #4a5568;
                --secondary-color: #e2e8f0;
                --accent-color: #3182ce;
                --danger-color: #e53e3e;
                --bg-color: #f7fafc;
                --text-color: #2d3748;
                --label-color: #718096;
                --border-color: #cbd5e0;
                --white: #ffffff;
                --success-color: #48bb78;
                --warning-color: #ed8936;
            }
            body {
                font-family: "Inter", sans-serif;
                background-color: var(--bg-color);
                color: var(--text-color);
                margin: 0;
                padding: 0;
            }
            .main-content {
                padding: 120px 1.5rem 40px;
                min-height: 100vh;
                display: flex;
                justify-content: center;
            }
            .content-wrapper {
                width: 100%;
                max-width: 1280px;
                display: flex;
                gap: 20px;
                align-items: flex-start;
            }
            .container {
                flex: 1;
                max-width: 100%;
                background-color: var(--white);
                padding: 2.5rem;
                border-radius: 1.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 2rem;
                padding-bottom: 1.5rem;
                border-bottom: 2px solid var(--secondary-color);
            }
            .page-header .title h1 {
                font-size: 1.8rem;
                margin: 0 0 0.5rem 0;
                color: var(--text-color);
            }
            .page-header .title p {
                font-size: 1rem;
                margin: 0;
                color: var(--label-color);
            }
            .form-section {
                margin-bottom: 2rem;
            }
            .form-section h2 {
                font-size: 1.2rem;
                color: var(--text-color);
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid var(--secondary-color);
            }
            .form-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            .form-group {
                display: flex;
                flex-direction: column;
            }
            .form-group.full-width {
                grid-column: 1 / -1;
            }
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
                color: var(--label-color);
                font-weight: 500;
            }
            .form-group label .required {
                color: var(--danger-color);
            }
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                font-size: 1rem;
                color: var(--text-color);
                background-color: #fdfdfd;
                transition:
                    border-color 0.3s,
                    box-shadow 0.3s;
            }
            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2);
            }
            .form-group textarea {
                min-height: 100px;
                resize: vertical;
                width: 100%;
                box-sizing: border-box;
            }
            .checkbox-group {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .checkbox-group input[type="checkbox"] {
                width: 18px;
                height: 18px;
                accent-color: var(--accent-color);
            }
            .checkbox-group label {
                margin-bottom: 0;
            }
            .btn-group {
                display: flex;
                gap: 1rem;
                justify-content: flex-end;
                margin-top: 2rem;
                padding-top: 1.5rem;
                border-top: 1px solid var(--secondary-color);
            }
            .btn {
                padding: 0.75rem 1.5rem;
                border-radius: 6px;
                border: none;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }
            .btn-primary {
                background-color: var(--accent-color);
                color: var(--white);
            }
            .btn-primary:hover {
                background-color: #2c5282;
            }
            .btn-primary:disabled {
                background-color: var(--border-color);
                cursor: not-allowed;
            }
            .btn-secondary {
                background-color: var(--secondary-color);
                color: var(--text-color);
            }
            .btn-secondary:hover {
                background-color: #cbd5e0;
            }
            .btn-back {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem 1.5rem;
                border-radius: 6px;
                border: 1px solid var(--border-color);
                background-color: var(--white);
                color: var(--text-color);
                font-size: 1rem;
                font-weight: 500;
                text-decoration: none;
                transition: all 0.3s;
            }
            .btn-back:hover {
                background-color: var(--secondary-color);
            }
            .alert {
                padding: 1rem;
                border-radius: 6px;
                margin-bottom: 1.5rem;
                display: none;
            }
            .alert-success {
                background-color: #c6f6d5;
                color: #2f855a;
                border: 1px solid #9ae6b4;
            }
            .alert-error {
                background-color: #fed7d7;
                color: #c53030;
                border: 1px solid #feb2b2;
            }
            .section-description {
                font-size: 0.9rem;
                color: var(--label-color);
                margin-bottom: 1rem;
            }

            @media (max-width: 768px) {
                .main-content {
                    padding: 100px 1rem 20px;
                }
                .content-wrapper {
                    flex-direction: column;
                    gap: 15px;
                }
                .container {
                    padding: 1.5rem;
                    border-radius: 1rem;
                }
                .page-header {
                    flex-direction: column;
                    gap: 1rem;
                }
                .page-header .title h1 {
                    font-size: 1.5rem;
                }
                .form-grid {
                    grid-template-columns: 1fr;
                }
                .btn-group {
                    flex-direction: column;
                }
                .btn {
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <Header client:load />
        <div class="main-content">
            <div class="content-wrapper">
                <Sidebar />
                <main class="container">
                    <div class="page-header">
                        <div class="title">
                            <h1 id="header-title">Cadastrar Novo Aluno</h1>
                            <p id="header-description">
                                Preencha os dados do aluno (brigadino/brigadina)
                            </p>
                        </div>
                        <a href="/admin/gerenciar-alunos" class="btn-back">
                            <span>‚Üê</span> Voltar
                        </a>
                    </div>

                    <div id="alert-success" class="alert alert-success">
                        Aluno salvo com sucesso!
                    </div>
                    <div id="alert-error" class="alert alert-error">
                        Erro ao salvar aluno. Por favor, tente novamente.
                    </div>

                    <form id="cadastro-form">
                        <!-- Dados Pessoais -->
                        <section class="form-section">
                            <h2>üìã Dados Pessoais</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label
                                        >Nome Completo <span class="required"
                                            >*</span
                                        ></label
                                    >
                                    <input
                                        type="text"
                                        name="nome"
                                        required
                                        placeholder="Nome completo do aluno"
                                    />
                                </div>
                                <div class="form-group">
                                    <label
                                        >Data de Nascimento <span
                                            class="required">*</span
                                        ></label
                                    >
                                    <input
                                        type="date"
                                        name="data_nascimento"
                                        required
                                    />
                                </div>
                                <div class="form-group">
                                    <label
                                        >CPF <span class="required">*</span
                                        ></label
                                    >
                                    <input
                                        type="text"
                                        name="cpf"
                                        required
                                        placeholder="000.000.000-00"
                                        maxlength="14"
                                    />
                                </div>
                                <FormSelect name="sexo" label="Sexo" required>
                                    <option value="">Selecione</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Feminino</option>
                                </FormSelect>
                                <div class="form-group">
                                    <label>Nome de Guerra</label>
                                    <input
                                        type="text"
                                        name="nome_guerra"
                                        placeholder="Apelido ou nome de guerra"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>Cidade</label>
                                    <input
                                        type="text"
                                        name="cidade"
                                        placeholder="Cidade do aluno"
                                    />
                                </div>
                            </div>
                        </section>

                        <!-- Dados Escolares -->
                        <section class="form-section">
                            <h2>üè´ Dados Escolares</h2>
                            <div class="form-grid">
                                <FormSelect
                                    name="serie"
                                    label="S√©rie/Ano"
                                    required
                                >
                                    <option value="">Selecione a s√©rie</option>
                                    <option value="Maternal">Maternal</option>
                                    <option value="Jardim I">Jardim I</option>
                                    <option value="Jardim II">Jardim II</option>
                                    <option value="1¬∫ Ano">1¬∫ Ano</option>
                                    <option value="2¬∫ Ano">2¬∫ Ano</option>
                                    <option value="3¬∫ Ano">3¬∫ Ano</option>
                                    <option value="4¬∫ Ano">4¬∫ Ano</option>
                                    <option value="5¬∫ Ano">5¬∫ Ano</option>
                                    <option value="6¬∫ Ano">6¬∫ Ano</option>
                                    <option value="7¬∫ Ano">7¬∫ Ano</option>
                                    <option value="8¬∫ Ano">8¬∫ Ano</option>
                                    <option value="9¬∫ Ano">9¬∫ Ano</option>
                                </FormSelect>
                                <FormSelect name="turma" label="Turma" required>
                                    <option value="">Selecione a turma</option>
                                    <!-- Turmas ser√£o carregadas dinamicamente -->
                                </FormSelect>
                            </div>
                        </section>

                        <!-- Informa√ß√µes M√©dicas -->
                        <section class="form-section">
                            <h2>üè• Informa√ß√µes M√©dicas</h2>
                            <div class="form-grid">
                                <FormSelect
                                    name="tipo_sanguineo"
                                    label="Tipo Sangu√≠neo"
                                >
                                    <option value="">Selecione</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </FormSelect>
                                <div class="form-group full-width">
                                    <label>Alergias</label>
                                    <textarea
                                        name="alergias"
                                        placeholder="Descreva as alergias do aluno, se houver"
                                    ></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Condi√ß√µes M√©dicas</label>
                                    <textarea
                                        name="condicoes_medicas"
                                        placeholder="Ex: Asma, diabetes, etc."
                                    ></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <div class="checkbox-group">
                                        <input
                                            type="checkbox"
                                            name="neurodivergente"
                                            id="neurodivergente"
                                        />
                                        <label for="neurodivergente"
                                            >Aluno neurodivergente (requer
                                            acompanhamento especial)</label
                                        >
                                    </div>
                                </div>
                                <div
                                    class="form-group full-width"
                                    id="observacoes-neuro"
                                    style="display: none;"
                                >
                                    <label
                                        >Observa√ß√µes sobre acompanhamento</label
                                    >
                                    <textarea
                                        name="observacoes_neuro"
                                        placeholder="Descreva as necessidades especiais de acompanhamento"
                                    ></textarea>
                                </div>
                            </div>
                        </section>

                        <!-- Respons√°veis -->
                        <ResponsaveisSection client:load />

                        <!-- Documentos (only in edit mode) -->
                        <section
                            id="documentos-section"
                            class="form-section"
                            style="display: none;"
                        >
                            <h2>üìé Documentos do Aluno</h2>
                            <p class="section-description">
                                Fa√ßa upload de laudos m√©dicos, documentos de
                                identifica√ß√£o e outros comprovantes.
                            </p>
                            <div id="documentos-container">
                                <DocumentosAluno
                                    client:load
                                    alunoId={0}
                                    alunoNome=""
                                />
                            </div>
                        </section>

                        <!-- Bot√µes de A√ß√£o -->
                        <div class="btn-group">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                onclick="window.location.href='/admin/gerenciar-alunos'"
                            >
                                Cancelar
                            </button>
                            <button
                                type="submit"
                                class="btn btn-primary"
                                id="btn-submit"
                            >
                                Cadastrar Aluno
                            </button>
                        </div>
                    </form>
                </main>
            </div>
        </div>

        <script>
            import { authStore } from "../../stores/auth";
            import { apiFetch } from "../../lib/api";

            // Edit mode state
            let isEditMode = false;
            let editingAlunoId: number | null = null;

            // Format CPF for display
            function formatCpf(cpf: string): string {
                if (!cpf) return "";
                const digits = cpf.replace(/\D/g, "");
                if (digits.length !== 11) return cpf;
                return `${digits.slice(0, 3)}.${digits.slice(3, 6)}.${digits.slice(6, 9)}-${digits.slice(9, 11)}`;
            }

            // Load turmas from API
            async function carregarTurmas(selectedTurmaId?: number) {
                try {
                    const response = await apiFetch(
                        "/turmas/listar?pageSize=100",
                    );
                    if (response.success && response.data) {
                        const responseData = response.data as {
                            data?: any[];
                            [key: string]: any;
                        };
                        const turmas = responseData.data || response.data || [];
                        const turmaSelect = document.querySelector(
                            'select[name="turma"]',
                        ) as HTMLSelectElement;
                        if (turmaSelect) {
                            // Keep the first option
                            turmaSelect.innerHTML =
                                '<option value="">Selecione a turma</option>';
                            (turmas as any[]).forEach((turma: any) => {
                                const option = document.createElement("option");
                                option.value = turma.id_turma;
                                option.textContent = `${turma.nome_turma} - ${turma.unidade_turma || "Sem unidade"}`;
                                if (
                                    selectedTurmaId &&
                                    turma.id_turma === selectedTurmaId
                                ) {
                                    option.selected = true;
                                }
                                turmaSelect.appendChild(option);
                            });
                        }
                    }
                } catch (error) {
                    console.error("Erro ao carregar turmas:", error);
                }
            }

            // Load aluno data for editing
            interface AlunoData {
                id_aluno: number;
                nome_aluno?: string;
                data_nascimento_aluno?: string;
                cpf_aluno?: string;
                tipo_sanguineo?: string;
                nome_guerra?: string;
                serie?: string;
                escola_unidade?: string;
                cidade?: string;
                neurodivergente?: boolean;
                alunos_por_turma?: Array<{ id_turma: number }>;
                // These fields don't exist in DB yet but form has them
                sexo?: string;
                serie?: string;
                alergias?: string;
                condicoes_medicas?: string;
                observacoes_neuro?: string;
            }

            async function carregarAluno(id: number) {
                try {
                    const response = await apiFetch(`/alunos/detalhe/${id}`);
                    console.log("[Edit] Full response:", response);

                    // The API returns { success, data: { success, data: aluno } }
                    // apiFetch wraps it as { success, data: serverResponse }
                    const serverResponse = response.data as any;
                    const aluno = (serverResponse?.data ||
                        serverResponse) as AlunoData;

                    console.log("[Edit] Aluno data:", aluno);

                    if (response.success && aluno) {
                        // Fill form fields
                        const form = document.getElementById(
                            "cadastro-form",
                        ) as HTMLFormElement;

                        // Personal data
                        (
                            form.querySelector(
                                'input[name="nome"]',
                            ) as HTMLInputElement
                        ).value = aluno.nome_aluno || "";
                        (
                            form.querySelector(
                                'input[name="data_nascimento"]',
                            ) as HTMLInputElement
                        ).value = aluno.data_nascimento_aluno || "";
                        (
                            form.querySelector(
                                'input[name="cpf"]',
                            ) as HTMLInputElement
                        ).value = formatCpf(aluno.cpf_aluno || "");

                        // Sexo
                        const sexoSelect = form.querySelector(
                            'select[name="sexo"]',
                        ) as HTMLSelectElement;
                        if (aluno.sexo) {
                            sexoSelect.value = aluno.sexo;
                        }

                        // Nome de guerra and cidade
                        (
                            form.querySelector(
                                'input[name="nome_guerra"]',
                            ) as HTMLInputElement
                        ).value = aluno.nome_guerra || "";
                        (
                            form.querySelector(
                                'input[name="cidade"]',
                            ) as HTMLInputElement
                        ).value = aluno.cidade || "";

                        // Serie/Ano
                        const serieSelect = form.querySelector(
                            'select[name="serie"]',
                        ) as HTMLSelectElement;
                        if (aluno.serie) {
                            serieSelect.value = aluno.serie;
                        }

                        // Turma - get from alunos_por_turma relationship
                        let turmaId: number | undefined;
                        if (
                            aluno.alunos_por_turma &&
                            aluno.alunos_por_turma.length > 0
                        ) {
                            turmaId = aluno.alunos_por_turma[0].id_turma;
                        }
                        await carregarTurmas(turmaId);

                        // Medical info
                        const tipoSanguineoSelect = form.querySelector(
                            'select[name="tipo_sanguineo"]',
                        ) as HTMLSelectElement;
                        if (aluno.tipo_sanguineo) {
                            tipoSanguineoSelect.value = aluno.tipo_sanguineo;
                        }

                        (
                            form.querySelector(
                                'textarea[name="alergias"]',
                            ) as HTMLTextAreaElement
                        ).value = aluno.alergias || "";
                        (
                            form.querySelector(
                                'textarea[name="condicoes_medicas"]',
                            ) as HTMLTextAreaElement
                        ).value = aluno.condicoes_medicas || "";

                        const neurodivergente = form.querySelector(
                            'input[name="neurodivergente"]',
                        ) as HTMLInputElement;
                        neurodivergente.checked =
                            aluno.neurodivergente || false;
                        if (aluno.neurodivergente) {
                            document.getElementById(
                                "observacoes-neuro",
                            )!.style.display = "block";
                            (
                                form.querySelector(
                                    'textarea[name="observacoes_neuro"]',
                                ) as HTMLTextAreaElement
                            ).value = aluno.observacoes_neuro || "";
                        }

                        // Load respons√°veis
                        await carregarResponsaveis(id);

                        return aluno;
                    }
                } catch (error) {
                    console.error("Erro ao carregar aluno:", error);
                    if (typeof window.showPageToast === "function") {
                        window.showPageToast(
                            "Erro ao carregar dados do aluno",
                            "error",
                        );
                    }
                }
                return null;
            }

            // Load respons√°veis for the aluno
            async function carregarResponsaveis(alunoId: number) {
                try {
                    const response = await apiFetch(
                        `/notificacoes/responsaveis-aluno/${alunoId}`,
                    );
                    console.log("[Edit] Responsaveis response:", response);
                    if (response.success && response.data) {
                        const serverResponse = response.data as any;
                        const responsaveis =
                            serverResponse?.data || serverResponse;
                        console.log("[Edit] Responsaveis data:", responsaveis);
                        // Dispatch event to ResponsaveisSection to load the data
                        window.dispatchEvent(
                            new CustomEvent("load-responsaveis", {
                                detail: { responsaveis },
                            }),
                        );
                    }
                } catch (error) {
                    console.error("Erro ao carregar respons√°veis:", error);
                }
            }

            // Check authentication
            document.addEventListener("DOMContentLoaded", async () => {
                const isAuthenticated = await authStore.checkAuth();

                if (!isAuthenticated) {
                    window.location.href = "/login";
                    return;
                }

                // Check if user is admin
                const user = authStore.getUser();
                if (!user || user.tipo !== "admin") {
                    if (typeof window.showPageToast === "function") {
                        window.showPageToast(
                            "Acesso negado. Apenas administradores podem gerenciar alunos.",
                            "error",
                        );
                    }
                    setTimeout(() => {
                        window.location.href = "/login";
                    }, 2000);
                    return;
                }

                // Check if we're in edit mode (URL has ?id=X)
                const urlParams = new URLSearchParams(window.location.search);
                const alunoId = urlParams.get("id");

                if (alunoId) {
                    isEditMode = true;
                    editingAlunoId = parseInt(alunoId, 10);

                    // Update page title and header
                    document.getElementById("page-title")!.textContent =
                        "Editar Aluno - Programa Bombeiro Mirim";
                    document.getElementById("header-title")!.textContent =
                        "Editar Aluno";
                    document.getElementById("header-description")!.textContent =
                        "Atualize os dados do aluno";
                    document.getElementById("btn-submit")!.textContent =
                        "Salvar Altera√ß√µes";

                    // Show documents section in edit mode
                    document.getElementById(
                        "documentos-section",
                    )!.style.display = "block";

                    // Load aluno data
                    const alunoData = await carregarAluno(editingAlunoId);

                    // Initialize documentos component with aluno data
                    window.dispatchEvent(
                        new CustomEvent("set-aluno-documentos", {
                            detail: {
                                alunoId: editingAlunoId,
                                alunoNome: alunoData?.nome_aluno || "",
                            },
                        }),
                    );
                } else {
                    // Load turmas for new aluno
                    await carregarTurmas();
                }
            });

            // CPF mask
            function applyCpfMask(input: HTMLInputElement) {
                input.addEventListener("input", (e) => {
                    const target = e.target as HTMLInputElement;
                    let value = target.value.replace(/\D/g, "");
                    if (value.length > 11) value = value.slice(0, 11);
                    value = value.replace(/(\d{3})(\d)/, "$1.$2");
                    value = value.replace(/(\d{3})(\d)/, "$1.$2");
                    value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                    target.value = value;
                });
            }

            // Phone mask
            function applyPhoneMask(input: HTMLInputElement) {
                input.addEventListener("input", (e) => {
                    const target = e.target as HTMLInputElement;
                    let value = target.value.replace(/\D/g, "");
                    if (value.length > 11) value = value.slice(0, 11);
                    if (value.length > 2) {
                        value = "(" + value.slice(0, 2) + ") " + value.slice(2);
                    }
                    if (value.length > 10) {
                        value = value.slice(0, 10) + "-" + value.slice(10);
                    }
                    target.value = value;
                });
            }

            // Apply masks to existing inputs
            document
                .querySelectorAll('input[name="cpf"], .cpf-input')
                .forEach((el) => applyCpfMask(el as HTMLInputElement));
            document
                .querySelectorAll(".telefone-input")
                .forEach((el) => applyPhoneMask(el as HTMLInputElement));

            // Toggle neurodivergente observations
            document
                .getElementById("neurodivergente")!
                .addEventListener("change", (e) => {
                    const target = e.target as HTMLInputElement;
                    document.getElementById(
                        "observacoes-neuro",
                    )!.style.display = target.checked ? "block" : "none";
                });

            // Form submit
            document
                .getElementById("cadastro-form")!
                .addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const form = e.target as HTMLFormElement;
                    const submitBtn = document.getElementById(
                        "btn-submit",
                    ) as HTMLButtonElement;
                    const alertSuccess =
                        document.getElementById("alert-success")!;
                    const alertError = document.getElementById("alert-error")!;

                    alertSuccess.style.display = "none";
                    alertError.style.display = "none";
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEditMode
                        ? "Salvando..."
                        : "Cadastrando...";

                    const formData = new FormData(form);

                    // Build aluno data in the format expected by backend
                    const aluno = {
                        nome_aluno: formData.get("nome"),
                        data_nascimento_aluno: formData.get("data_nascimento"),
                        cpf_aluno: formData
                            .get("cpf")
                            ?.toString()
                            .replace(/\D/g, ""),
                        sexo: formData.get("sexo") || null,
                        nome_guerra: formData.get("nome_guerra") || null,
                        cidade: formData.get("cidade") || null,
                        serie: formData.get("serie") || null,
                        turma_id: formData.get("turma") || null,
                        tipo_sanguineo: formData.get("tipo_sanguineo") || null,
                        alergias: formData.get("alergias") || null,
                        condicoes_medicas:
                            formData.get("condicoes_medicas") || null,
                        neurodivergente:
                            formData.get("neurodivergente") === "on",
                        observacoes_neuro:
                            formData.get("observacoes_neuro") || null,
                    };

                    // Collect first respons√°vel (backend expects single responsavel object)
                    const nomeResp = formData.get("responsavel_nome_0");
                    const idResp = formData.get("responsavel_id_0");
                    const responsavel = nomeResp
                        ? {
                              id_responsavel: idResp ? Number(idResp) : null,
                              nome_responsavel: nomeResp,
                              cpf_responsavel:
                                  formData
                                      .get("responsavel_cpf_0")
                                      ?.toString()
                                      .replace(/\D/g, "") || null,
                              parentesco: formData.get(
                                  "responsavel_parentesco_0",
                              ),
                              telefone_responsavel:
                                  formData
                                      .get("responsavel_telefone_0")
                                      ?.toString()
                                      .replace(/\D/g, "") || null,
                              email_responsavel:
                                  formData.get("responsavel_email_0") || null,
                          }
                        : null;

                    // Collect additional respons√°veis if any
                    const responsaveisAdicionais: any[] = [];
                    let i = 1;
                    while (true) {
                        const nome = formData.get(`responsavel_nome_${i}`);
                        if (!nome) break;

                        const idRespAdicional = formData.get(
                            `responsavel_id_${i}`,
                        );
                        responsaveisAdicionais.push({
                            id_responsavel: idRespAdicional
                                ? Number(idRespAdicional)
                                : null,
                            nome_responsavel: nome,
                            cpf_responsavel:
                                formData
                                    .get(`responsavel_cpf_${i}`)
                                    ?.toString()
                                    .replace(/\D/g, "") || null,
                            parentesco: formData.get(
                                `responsavel_parentesco_${i}`,
                            ),
                            telefone_responsavel:
                                formData
                                    .get(`responsavel_telefone_${i}`)
                                    ?.toString()
                                    .replace(/\D/g, "") || null,
                            email_responsavel:
                                formData.get(`responsavel_email_${i}`) || null,
                        });
                        i++;
                    }

                    try {
                        let response;

                        if (isEditMode && editingAlunoId) {
                            // Collect all responsaveis for update
                            const responsaveisParaAtualizar: Array<{
                                id_responsavel: number;
                                parentesco?: string;
                            }> = [];

                            // Collect primary responsavel
                            const idRespPrimary =
                                formData.get("responsavel_id_0");
                            const parentescoPrimary = formData.get(
                                "responsavel_parentesco_0",
                            );
                            if (idRespPrimary) {
                                responsaveisParaAtualizar.push({
                                    id_responsavel: Number(idRespPrimary),
                                    parentesco:
                                        parentescoPrimary?.toString() || null,
                                });
                            }

                            // Collect additional responsaveis
                            let idx = 1;
                            while (true) {
                                const idRespAdditional = formData.get(
                                    `responsavel_id_${idx}`,
                                );
                                if (!idRespAdditional) break;
                                const parentescoAdditional = formData.get(
                                    `responsavel_parentesco_${idx}`,
                                );
                                responsaveisParaAtualizar.push({
                                    id_responsavel: Number(idRespAdditional),
                                    parentesco:
                                        parentescoAdditional?.toString() ||
                                        null,
                                });
                                idx++;
                            }

                            console.log(
                                "[Edit] Respons√°veis para atualizar:",
                                responsaveisParaAtualizar,
                            );

                            // Update existing aluno with responsaveis
                            response = await apiFetch(
                                `/alunos/atualizar/${editingAlunoId}`,
                                {
                                    method: "PUT",
                                    body: JSON.stringify({
                                        ...aluno,
                                        responsaveis: responsaveisParaAtualizar,
                                    }),
                                },
                            );
                        } else {
                            // Build request body for new aluno in backend expected format
                            const requestBody = {
                                aluno,
                                responsavel,
                                responsaveisAdicionais:
                                    responsaveisAdicionais.length > 0
                                        ? responsaveisAdicionais
                                        : undefined,
                            };

                            response = await apiFetch("/alunos", {
                                method: "POST",
                                body: JSON.stringify(requestBody),
                            });
                        }

                        if (response.success) {
                            alertSuccess.textContent = isEditMode
                                ? "Aluno atualizado com sucesso!"
                                : "Aluno cadastrado com sucesso!";
                            alertSuccess.style.display = "block";

                            if (!isEditMode) {
                                form.reset();
                            }

                            window.scrollTo({ top: 0, behavior: "smooth" });

                            setTimeout(() => {
                                window.location.href =
                                    "/admin/gerenciar-alunos";
                            }, 2000);
                        } else {
                            alertError.textContent =
                                response.error ||
                                (isEditMode
                                    ? "Erro ao atualizar aluno"
                                    : "Erro ao cadastrar aluno");
                            alertError.style.display = "block";
                            window.scrollTo({ top: 0, behavior: "smooth" });
                        }
                    } catch (error) {
                        console.error("Erro:", error);
                        alertError.textContent =
                            "Erro de conex√£o com o servidor";
                        alertError.style.display = "block";
                        window.scrollTo({ top: 0, behavior: "smooth" });
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = isEditMode
                            ? "Salvar Altera√ß√µes"
                            : "Cadastrar Aluno";
                    }
                });
        </script>
        <PageToast />
    </body>
</html>
